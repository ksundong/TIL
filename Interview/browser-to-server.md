# 브라우저에서 서버 통신과정

## 개요

보통 질문은 주소창에 url을 입력했을 때, 어떻게 통신이 이루어지는지 질문을 합니다.  
https의 경우 추가적인 통신과정이 필요한데, 대개의 신입면접에서는 그정도까지 요구하지는 않는 편입니다. 그래도 간단히 다뤄보고자 합니다.

먼저 보통 우리가 입력하는 url은 protocol, domain, subdomain, path 정도로 나눌 수 있는데 여기서 중요한 부분은 domain입니다.

이 domain을 가지고는 브라우저가 서버에 요청을 보낼 수 없습니다. domain에 대해서 안다면, domain은 사람이 ip를 외우기 어렵기 때문에 외우기 쉬운 문자형식으로 ip와 매핑을 합니다. 흔히 DNS Table이라고 부르죠. 즉, ip를 통해서 요청을 보내야 합니다.

## DNS Lookup

따라서 ip를 알아내는 과정이 필요합니다. 이를 DNS Lookup 이라고 합니다. DNS 서버의 통신은 **UDP통신**을 기반으로 합니다.

[브라우저에서 DNS Lookup은 어떤과정으로 진행되는가](../Network/browser-dnslookup-process.md)

이 자료는 제가 Chrome 브라우저와 MacOS 환경에서 테스트한 내용을 기반으로 작성되어 있습니다.

## TCP 3Way Handshake

이렇게 ip를 알아냈다면 HTTP 통신은 TCP를 이용하므로 TCP 3way handshaking 을 통해 데이터를 전송할 준비가 됬음을 알아냅니다. TCP 3way handshake는 TCP를 사용하는 장치들 사이에 논리적인 접속을 정립하기 위해 사용됩니다.

TCP 프로토콜은 정확한 전송을 보장하는 것을 목적으로 하므로 연결상태를 확인하는 과정을 TCP 3way handshake라고 합니다.

간단하게 정리하자면

1. Client측에서 Server 측에 SYN(n) 패킷을 전송합니다.
2. Server 측에서는 SYN(m)과 ACK(n+1) 패킷을 전송합니다. (한 패킷에 담겨서 전송됩니다.)
3. Client 측에서는 다시 ACK(m+1) 패킷을 전송합니다.

위의 과정중에서 오류가 발생한다면 연결이 불안정함을 알 수 있습니다.

위의 과정을 거치고 나면 TCP 소켓이 형성됩니다.

## HTTP 통신 과정

브라우저는 자체적으로 네트워크를 통해 요청을 보낼 수 없습니다. OS에 Request 송신을 요청해야 합니다. 이를 담당하는 부분을 프로토콜 스택이라고 합니다.

Request 메시지는 프로토콜 스택에서 패킷에 담고 수신처의 주소 등을 제어 정보에 담아 LAN 어댑터에 의해 전기 신호로 변환되어 패킷이 네트워크 속으로 들어가게 됩니다.

이 패킷들은 스위칭 허브 등을 경유하여 최종적으로 인터넷 접속용 라우터에 도착합니다. 이후 통신사(provider)가 패킷을 운반합니다.

provider가 운반한 패킷은 웹 서버측의 LAN에 도착하면 방화벽에서 패킷을 검사합니다. 그리고 캐시 서버가 있다면 다시 이용할 수 있는 데이터는 캐시 서버에서 응답하게 됩니다.

또한 대규모 웹 사이트라면 로드 밸런서와 같은 부하 분산 장치가 설치되어 있을 수 있습니다.

웹 서버에 도착한 패킷은 웹 서버의 프로토콜 스택에 의해 원래 리퀘스트 메시지로 복원되고, 이를 웹 애플리케이션 서버에 전달해줍니다.

웹 애플리케이션 서버는 리퀘스트 메시지를 읽고 이에 적당한 응답을 작성하여 클라이언트에게 다시 보냅니다.

이 과정은 메시지 송신과 정확히 반대로 동작하게 됩니다.

응답이 클라이언트에 도착하면 데이터를 추출하여 화면에 표시하게 됩니다.

## TCP 4Way Handshake

TCP 통신을 종료하기 위한 작업입니다.

1. Client에서 종료를 알리는 FIN 패킷을 전송합니다.
2. Server에서 FIN을 받았다는 ACK 패킷을 전송하고, CLOSE-WAIT 상태가 됩니다.
3. 연결을 종료한 후 Server가 Client에 FIN 패킷을 전송합니다.
4. Client는 FIN을 받았다는 ACK 패킷을 전송하고, TIME-WAIT 상태가 됩니다.
5. Server는 소켓을 Close합니다.
6. TIME-WAIT 상태에서는 FIN을 수신해도, 일정시간 접속이 유지되며 도착하지 않은 패킷을 기다립니다.

## References

성공과 실패를 결정하는 1%의 네트워크 원리

<https://real-dongsoo7.tistory.com/73>
