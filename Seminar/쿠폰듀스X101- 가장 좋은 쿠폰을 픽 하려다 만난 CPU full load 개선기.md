# 쿠폰듀스X101: 가장 좋은 쿠폰을 픽 하려다 만난
CPU full load 개선기

황도영 님(dodo45133@gmail.com)

1. 무엇이 문제일까?
2. 왜 느릴까?
3. 해결해 보자!
4. 개선 후 결과 그리고 회고

## 1. 무엇이 문제일까?

NCP(클라우드 기반 커머스 플랫폼), API 연동방식

응답이 지연되는 장애가 발생함

Heap 그래프(트래픽이 많았던 것일까?)

**CPU 그래프(CPU가 매우 바빴음)**

Thread Dump(무언가가 반복 호출된다.) - 무한루프, 깊은 재귀탐색

최대 쿠폰 적용 금액 계산 API가 문제
상품의 목록과 쿠폰의 목록을 조합하여 가장 물건을 싸게 구입할 수 있는 쿠폰을 적용시켜주는 기능

## 2. 왜 느릴까?

상품 쿠폰 API가 느린 이유
다양한 쿠폰 기능을 제공함. (여러 spec들이 얽혀서 어렵게 만듬)

Q1. 가장 좋은 쿠폰순으로 매칭하면 되지 않을까?(Greedy)

A1. 언제나 가장 좋은 쿠폰이란 존재하지 않는다.

Q2. 가장 할인액이 큰 순서대로 매칭하면 어떨까?

A2. 사용제한이 있는 경우가 있어서 적용이 불가능한 경우가 있다.(다른 상품에 양보해야 함.)

어떻게 빠르게 계산할까?

다양한 쿠폰 종류가 있다.(상품 쿠폰, 상품 플러스 쿠폰)
서로에게 독립적인 쿠폰임(정가에 의존함)

장바구니 쿠폰은 할인가에 의존하는 의존적인 쿠폰임
그래서 서로에게 의존적인 관계가 됨.

Legacy Code=> 모두 구해서 비교
사용자 입력에 너무나 큰 성능 편차를 보이는 알고리즘(상품 개수가 늘어남에 따라 연산횟수가 폭발적으로 증가(지수승이므로))

## 3. 해결해 보자!

탐욕법적용은 어려움

1. 쿠폰간 의존관계 끊기(장바구니 쿠폰은 나중에 계산, 두 쿠폰의 할인가 합 > 상품가격인 경우(마이너스 판매가 무시하기))
2. $M^p$ 알고리즘 개선
   x, y가 겹치지 않음(체스 룩 놓기) => Assignment problem 최소 비용문제와 비슷함
   헝가리안 알고리즘: BigO($K^3$) 3가지 단계: 최소매칭에 관심이 있는 알고리즘
   1. Input을 X와 Y의 크기가 같은 K X K의 정방행렬로 만들어진다.
      Mock 상품을 생성함(0 Injection)
   2. 최소가 아닌 최대를 원하니 가장 큰 수에 각 숫자를 뺀다.(숫자의 반전) 뒤바뀐 표에서 최소매칭
   3. 같은 수를 빼면, 값은 달라지나, 대소관계는 달라지지 않는다. König's theorem 참조
      최소 라인으로 0의 성분의 라인 제거
   4. 남은 수 중 0이 아닌 가장 작은 수로 각각 뺀다.
      음수 발생시 0 이상의 수가 되도록 다시 더한다.
   5. 최소 라인으로 0을 커버하는 라인의 개수가 K개인지 확인

## 4. 개선 후 결과 그리고 회고

$BigO((M*N)^p)*C$ => $BigO(M^p)$

속도 향상이 눈에 띄게 이루어짐

https://github.com/dodo4513/HungarianAndDfs

## 5. 결론

First, solve the problem, Then, write the code. - John Johnson

## 6. Q&A

